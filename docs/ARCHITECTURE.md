# Архитектура Smashers Backend

## Общая схема

```
┌─────────────────┐
│ Django Админка  │
│  (источник)     │
└────────┬────────┘
         │
         │ Парсер (Puppeteer)
         │ Только чтение (GET)
         ▼
┌─────────────────┐
│   Парсер        │
│  (parseAll)     │
└────────┬────────┘
         │
         ├─────────────────┐
         │                 │
         ▼                 ▼
┌─────────────────┐  ┌─────────────────┐
│  PostgreSQL      │  │  Google Sheets   │
│   (основное)     │  │   (опционально)  │
└────────┬────────┘  └─────────────────┘
         │
         │ API запросы
         ▼
┌─────────────────┐
│  REST API       │
│  (Express)      │
└────────┬────────┘
         │
         │ HTTP запросы
         ▼
┌─────────────────┐
│   Фронтенд      │
│   (React)       │
└─────────────────┘
```

## Поток данных

### 1. Парсинг из Django

**Парсер** (`src/parsers/`) использует Puppeteer для:
- Авторизации в Django админке
- Чтения данных из таблиц (только GET запросы)
- Парсинга HTML таблиц
- Преобразования в структурированные объекты

**Важно:** Парсер только читает данные, ничего не изменяет в Django!

### 2. Сохранение в PostgreSQL

**dbSync.service.js** сохраняет распарсенные данные:
- `saveCategories()` - категории
- `saveLocations()` - локации  
- `saveMemberships()` - абонементы
- `saveSessions()` - тренировки (с поддержкой пятничных обновлений)

Использует Prisma для работы с БД:
- `upsert` - создает или обновляет записи
- Автоматически обрабатывает связи (foreign keys)

### 3. Опциональная синхронизация с Google Sheets

Если Google Sheets настроены, парсер также обновляет таблицы:
- Это опционально и не обязательно
- Можно пропустить, если не нужен просмотр/редактирование в таблицах

### 4. API для фронтенда

**REST API** (`src/routes/api.routes.js`) предоставляет:
- `GET /api/categories` - категории
- `GET /api/memberships` - абонементы
- `GET /api/locations` - локации
- `GET /api/sessions` - тренировки (с фильтрами)
- `POST /api/booking` - отправка заявок

Все данные читаются из PostgreSQL через Prisma.

## Пятничные обновления

### Как это работает:

1. **Парсер проверяет день недели** при каждом запуске
2. **Если пятница:**
   - Удаляет старые тренировки (старше текущей недели)
   - Сохраняет новую неделю занятий (ПН-ВС)
3. **Если не пятница:**
   - Обновляет существующие тренировки
   - Добавляет новые (если есть)

### Cron расписание:

По умолчанию парсер запускается каждый час. В пятницу автоматически срабатывает логика очистки старых сессий.

Можно настроить через `.env`:
```env
# Кастомное расписание
PARSER_CRON_SCHEDULE=0 * * * *  # Каждый час

# Или через интервал
PARSE_INTERVAL_HOURS=1
```

## Структура базы данных

### Основные таблицы:

- **categories** - категории тренировок
- **memberships** - абонементы (включая id=2 для разовых)
- **locations** - локации
- **sessions** - тренировки (связи с category и location)

### Вспомогательные таблицы:

- **booking_requests** - заявки с сайта
- **sync_status** - история синхронизаций

## Рекомендуемая архитектура

### Минимальная (без Google Sheets):

```
Django → Парсер → PostgreSQL → API → Фронтенд
```

**Плюсы:**
- Проще настройка
- Быстрее работа
- Меньше зависимостей

### Полная (с Google Sheets):

```
Django → Парсер → PostgreSQL + Google Sheets → API → Фронтенд
```

**Плюсы:**
- Можно просматривать данные в таблицах
- Можно редактировать вручную (если нужно)
- Резервное копирование

## Рекомендации

1. **Используйте PostgreSQL** - это основное хранилище для API
2. **Google Sheets опционален** - можно пропустить
3. **Парсер работает автоматически** - через cron job
4. **Пятничные обновления** - работают автоматически

## Безопасность

- Парсер только читает из Django (безопасно)
- API имеет rate limiting
- Защищенные эндпоинты требуют API ключ
- `.env` файл в `.gitignore`
